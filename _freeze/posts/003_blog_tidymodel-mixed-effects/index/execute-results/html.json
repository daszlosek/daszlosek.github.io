{
  "hash": "76904c4d754dd73fab9af6173621fcc1",
  "result": {
    "markdown": "---\ntitle: \"A basic tutorial on plotting mixed effects using tidymodels\"\nauthor: \"Donald Szlosek\"\ndate: 2020-09-03T21:19:39-05:00\ncategories: [\"R\",\"Statistics\"]\ntags: [\"R\",\"Statistics\"]\nimage: \"tidymodel_git_comment2.PNG\"\n---\n\n\nIn R there are a ton of packages available to regression models including mixed effects model but one of the biggest issues is the vast difference in syntax needed for each of the modeling packages. Tidymodels was developed to solve this problem with the goal of having similar syntax style to the other tidyverse packages. Tidymodels itself is a \"meta-package\" consisting of a bunch {https://tidymodels.tidymodels.org/} of packages for modeling and statistical analysis with a focus on using the design philosophy of the tidyverse packages.\n\nOne of the current packages in development (as of this blog post) is the multilevelmod package for hierarchical modeling.\n\nIn this tutorial I am going to go through how to create a mixed effects model in `R` using the `tidymodels` and `multilevelmod` packages and how to plot the random intercepts using `ggplot2`. This blog post is just focused on using tidymodels and is not an indept overview of what mixed effects models are or how to use them.\n\nFirst lets load our packages of interest. For the `multilevelmod` package (as of the time of this blog post) you will need to install it through github using `devtools::install_github()`. I ended up running into a little bit of a problem with an out of date `Rcpp` package. Deleting the folder manually and then re-installing ended up doig the trick. We will also be loading in one of R's most used mixed effects modeling packages,`lme4`, to get some data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#install.packages(\"pacman\")\n#load required packages\npacman::p_load(\"tidyverse\",\"lme4\")\n\n# install multilevelmod\n#devtools::install_github(\"tidymodels/multilevelmod\")\n\nlibrary(\"multilevelmod\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: parsnip\n```\n:::\n:::\n\n\nNow lets load in the sleep study dataset from the `lme4` package. I am also going to create a fake categorical variable to use as a fixed effect in the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load sleep study and create a fake category\nset.seed(666) #\\m/ rock on\nsleepstudy <- lme4::sleepstudy %>% group_by(Subject) %>% \n              # creating a new random category with 3 levels to explore group effects\n              mutate(cat = sample( LETTERS[1:3], 1, replace=TRUE, prob=c(0.25, 0.50, 0.25))) %>%\n              ungroup()\n```\n:::\n\n\nThe `Tidymodels` syntax requires that we set the \"engine\" for the type of model that we want to use. It is kind of like picking the type of car to use in MarioKart. You want to use the right engine for the right type of data. Since we are interested in looking at repeated measures data using a mixed effects model we will be using the \"lmer\" engine. We can set up the engine with the following code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set engine for mixed effects models\nmixed_model_spec <- linear_reg() %>% set_engine(\"lmer\")\n```\n:::\n\n\nNext we can build the model using `Reaction` as our dependent variable, `Days` and `cat` as our fixed effects and `Subject` as our random effect. The random effect syntax following that of the `lme4` package using `(1|Subject)` to define `Subject` as the random intercept.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create model\nmixed_model_fit_tidy <- mixed_model_spec %>% fit(Reaction ~ Days + cat + (1 | Subject), data = sleepstudy)\n\nmixed_model_fit_tidy\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nparsnip model object\n\nLinear mixed model fit by REML ['lmerMod']\nFormula: Reaction ~ Days + cat + (1 | Subject)\n   Data: data\nREML criterion at convergence: 1769.298\nRandom effects:\n Groups   Name        Std.Dev.\n Subject  (Intercept) 39.58   \n Residual             30.99   \nNumber of obs: 180, groups:  Subject, 18\nFixed Effects:\n(Intercept)         Days         catB         catC  \n    248.683       10.467        3.407       11.516  \n```\n:::\n:::\n\n\nNow that we have created our model. Lets take a look at the predicted probabilities. To do this, we will create a data frame with all the different combinations of our fixed and random effects.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpanded_df_tidy <- with(sleepstudy,\n                    data.frame(\n                      expand.grid(Subject=levels(Subject),\n                                  #cat = unique(cat),\n                                  Days=seq(min(Days),max(Days),length=51))))\n\nexpanded_df_tidy <- sleepstudy %>% tidyr::expand(Subject,Days,cat)\n\nexpanded_df_tidy\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 540 × 3\n   Subject  Days cat  \n   <fct>   <dbl> <chr>\n 1 308         0 A    \n 2 308         0 B    \n 3 308         0 C    \n 4 308         1 A    \n 5 308         1 B    \n 6 308         1 C    \n 7 308         2 A    \n 8 308         2 B    \n 9 308         2 C    \n10 308         3 A    \n# … with 530 more rows\n```\n:::\n:::\n\n\nWe can use this data frame and the `predict()` to get the predictions from our model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredicted_df_tidy <- mutate(expanded_df_tidy,\n                            pred = predict(mixed_model_fit_tidy,\n                                           new_data=expanded_df_tidy, \n                                           type = \"raw\", opts=list(re.form=NA)))\n\n\npredicted_df_tidy\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 540 × 4\n   Subject  Days cat    pred\n   <fct>   <dbl> <chr> <dbl>\n 1 308         0 A      249.\n 2 308         0 B      252.\n 3 308         0 C      260.\n 4 308         1 A      259.\n 5 308         1 B      263.\n 6 308         1 C      271.\n 7 308         2 A      270.\n 8 308         2 B      273.\n 9 308         2 C      281.\n10 308         3 A      280.\n# … with 530 more rows\n```\n:::\n:::\n\n\nWhen looking at the prediction output, notice that we are getting the same predictions for each subject. The `predict` function is currently giving us predictions for the fixed effects. If were were to run this same code using `predict()` with `lme4` we would get the predictions for the random effects for each \\``Subject`.\n\nWhat is going on here? The issue is that `multilevelmod` package internally sets the default for prediction to `re.form = NA;`. In `lme4` the default for predictions is `re.form = NULL` (i.e. include all random effects in the prediction).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::include_graphics(\"tidymodel_git_comment.PNG\")\n```\n\n::: {.cell-output-display}\n![](tidymodel_git_comment.PNG){width=692}\n:::\n:::\n\n\nWe can include `re.form = NULL` in the `predict()` function by using the `opts` argument.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#update predictions\npredicted_df_tidy <- mutate(expanded_df_tidy,\n                            # get random predictions\n                            pred_rand = predict(mixed_model_fit_tidy,\n                                                new_data=expanded_df_tidy, \n                                                type = \"raw\", opts=list(re.form=NULL)),\n                            # get fixed effect predictions\n                            pred_fixed = predict(mixed_model_fit_tidy,\n                                                new_data=expanded_df_tidy, \n                                                type = \"raw\", opts=list(re.form=NA)))\n\npredicted_df_tidy\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 540 × 5\n   Subject  Days cat   pred_rand pred_fixed\n   <fct>   <dbl> <chr>     <dbl>      <dbl>\n 1 308         0 A          292.       249.\n 2 308         0 B          296.       252.\n 3 308         0 C          304.       260.\n 4 308         1 A          303.       259.\n 5 308         1 B          306.       263.\n 6 308         1 C          314.       271.\n 7 308         2 A          313.       270.\n 8 308         2 B          317.       273.\n 9 308         2 C          325.       281.\n10 308         3 A          324.       280.\n# … with 530 more rows\n```\n:::\n:::\n\n\nNow that we have both the predictions for the fixed and random effects we can plot them using `ggplot2`!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(predicted_df_tidy) +\n       facet_wrap(.~cat) + \n       geom_line(aes(x=Days,y=pred_fixed), size = 1) + \n       geom_line(aes(x=Days,y=pred_rand,colour=Subject)) +\n       scale_y_continuous(\"Predicted\") + \n       theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}